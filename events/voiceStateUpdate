const TempVC = require('../models/tempvc');
const Guild = require('../models/guild');
const { ChannelType, PermissionFlagsBits } = require('discord.js');

module.exports = {
  name: 'voiceStateUpdate',
  async execute(client, oldState, newState) {

    // Joining Temp VC
    if (!oldState.channelId && newState.channelId) {
      const guildData = await Guild.findOne({ guildId: newState.guild.id });
      if (!guildData || !guildData.tempVCCategory) return;

      const category = newState.guild.channels.cache.get(guildData.tempVCCategory);
      if (!category) return;

      if (newState.channel.name.includes('Join Temp VC')) {
        const tempVC = await newState.guild.channels.create({
          name: `${newState.member.user.username}'s VC`,
          type: ChannelType.GuildVoice,
          parent: category,
          permissionOverwrites: [
            { id: newState.guild.roles.everyone, deny: [PermissionFlagsBits.Connect] },
            { id: newState.member.id, allow: [PermissionFlagsBits.Connect, PermissionFlagsBits.ManageChannels] }
          ]
        });

        await TempVC.create({ guildId: newState.guild.id, userId: newState.member.id, channelId: tempVC.id });
        newState.setChannel(tempVC);
      }
    }

    // Delete VC when empty
    if (oldState.channelId && !newState.channelId) {
      const temp = await TempVC.findOne({ channelId: oldState.channelId });
      if (temp) {
        const channel = oldState.guild.channels.cache.get(temp.channelId);
        if (channel && channel.members.size === 0) {
          await channel.delete();
          await temp.delete();
        }
      }
    }
  }
      };
